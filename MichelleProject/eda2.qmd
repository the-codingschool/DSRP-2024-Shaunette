```{r}
# Load libraries
library(ggplot2)
library(readr)
library(data.table)
library(dplyr)
library(janitor)

readRDS("/Users/michelle/Downloads/DSRP/DSRP-2024-Shaunette/MichelleProject/cfs_clean.rds")
readRDS("/Users/michelle/Downloads/DSRP/DSRP-2024-Shaunette/MichelleProject/exact_locs.rds")
unemployment <- readRDS("/Users/michelle/Downloads/DSRP/DSRP-2024-Shaunette/MichelleProject/unemployment_clean.rds")
head(unemployment)
```

Testing Getting Municipality from Small Dataset's Longitude and Latitude

```{r}
# Looking at resulting dataset --> quarter column aligns with unemployment data
dataHead <- head(coords, 5) %>%reverse_geocode(lat = latitude, long = longitude, method = 'osm',address = address_found, full_results = TRUE)
dataHead
colnames(dataHead)
unique(dataHead$municipality)
unique(dataHead$quarter)
```

Identify High Density Area and Investigate Unemployment

```{r}
# Inspect the data
summary(exact_locs$latitude)
summary(exact_locs$longitude)

# Print the first few rows of the data to see actual values
head(exact_locs)
head(unemployment)

# Assuming highest density is around 41.8875, 87.625
high_density_area <- exact_locs %>%
  filter(latitude > 41.8775 & latitude < 41.8975 & longitude > -87.635 & longitude < -87.615) %>%
  select(latitude, longitude, quarter, place_id, address_found)

head(high_density_area)

aggregated_data <- high_density_area %>%
  group_by(latitude, longitude) %>%
  summarise(inspection_count = n(), .groups = 'drop')

merged_dense_data <- high_density_area %>%
  unique() %>%
  left_join(aggregated_data, by = c("latitude", "longitude")) %>%
  full_join(unemployment, by = c("quarter" = "community_area_name"), relationship = "many-to-many")
head(merged_dense_data)
print(get_dupes(merged_dense_data))

ggplot(merged_dense_data, aes(x = percent_aged_16_unemployed, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Unemployment Rate and Inspection Count in Dense Area",
       x = "Unemployment Rate (%)",
       y = "Inspection Count") +
  theme_minimal()

ggplot(merged_dense_data, aes(x = percent_aged_25_without_high_school_diploma, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Percent without Diploma  and Inspection Count in Dense Area",
       x = "(%) aged 25 without HS diploma",
       y = "Inspection Count") +
  theme_minimal()

ggplot(merged_dense_data, aes(x = hardship_index, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "hardship_index and Inspection Count in Dense Area",
       x = "Hardship Index",
       y = "Inspection Count") +
  theme_minimal()
```

Pandemic Investigation

```{r}
official_pandemic_date = as.Date("2020-03-11")

risk_pre_covid <- cfs_clean |>
  select(latitude, longitude, risk_numeric, inspection_date) |>
  filter(inspection_date < official_pandemic_date) |>
  group_by(latitude, longitude) |>
  summarise(avg_risk = mean(risk_numeric, na.rm = TRUE), .groups = 'drop')

risk_post_covid <- cfs_clean |>
  select(latitude, longitude, risk_numeric, inspection_date) |>
  filter(inspection_date > official_pandemic_date) |>
  group_by(latitude, longitude) |>
  summarise(avg_risk = mean(risk_numeric, na.rm = TRUE), .groups = 'drop')

```

```{r}
avg_risk <- cfs_clean |>
  select(latitude, longitude, risk_numeric) |>
  group_by(latitude, longitude) |>
  summarise(avg_risk = mean(risk_numeric, na.rm = TRUE), .groups = 'drop')

complaints_per_location <- cfs_clean %>%
  filter(inspection_type == "Complaint" | inspection_type == "Complaint Re-Inspection") %>%
  group_by(latitude, longitude) %>%
  summarise(complaint_count = n(), .groups = 'drop')

pass_per_location <- cfs_clean%>%
  filter(results == "Pass" | results =="Pass w/ Conditions") %>%
  group_by(latitude, longitude) %>%
  summarise(pass_count = n(), .groups = 'drop')

locs <- exact_locs |>
  select(longitude, latitude, address_found, place_id, quarter)

aggregated_data <- locs %>%
   group_by(latitude, longitude) %>%
   summarise(inspection_count = n(), .groups = 'drop')

 merged_data <- locs %>%
   unique() %>%
   left_join(aggregated_data, by = c("latitude", "longitude")) %>%
   left_join(avg_risk, by = c("latitude", "longitude")) %>%
   left_join(complaints_per_location, by = c("latitude", "longitude")) %>%
   left_join(pass_per_location, by = c("latitude", "longitude")) %>%
   full_join(unemployment, by = c("quarter" = "community_area_name"), relationship = "many-to-many")
 
 print(head(merged_data))
 print(get_dupes(merged_dense_data))
 saveRDS(merged_data, "/Users/michelle/Downloads/DSRP/DSRP-2024-Shaunette/MichelleProject/merged_data.rds")
```

```         
```

Graphing Relationship between Unemployment and Inspection Counts

```{r}
merged_data_2 <- merged_data |>
  filter(inspection_count <3000)

ggplot(merged_data_2, aes(x = hardship_index, y = pass_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Hardship Index vs Inspection Counts",
       x = "Hardship Index",
       y = "Inspection Count") +
  theme_minimal()

ggplot(merged_data_2, aes(x = percent_aged_16_unemployed, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Unemployment Rate vs Inspection Counts",
       x = "Unemployment Rate (%)",
       y = "Inspection Count") +
  theme_minimal()

ggplot(merged_data_2, aes(x = percent_aged_25_without_high_school_diploma, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Education Rate vs Inspection Counts",
       x = "Percent Aged 25 without High School Diploma",
       y = "Inspection Count") +
  theme_minimal()
```

```{r}
colnames(merged_data)
correlation <- cor(merged_data$avg_risk, merged_data$pass_count, use = "complete.obs")
print(correlation)

ggplot(merged_data_2, aes(x = complaint_count, y = inspection_count)) +
  geom_point(alpha = 0.5, size = 0.5) +
  labs(title = "Correlation between Complaints and Inspection Count",
       x = "Complaints",
       y = "Inspection Count") +
  theme_minimal()
```
